<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      text-align: center;
      padding: 20px;
      background: #f4f6f9;
    }
    video {
      width: 300px;
      border: 2px solid #333;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      border-radius: 8px;
      border: 1px solid #aaa;
      font-size: 16px;
    }
    button {
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    .card {
      background: #fff;
      margin: 15px auto;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 400px;
      text-align: right;
    }
    h2 { color: #333; }
  </style>
</head>
<body>
  <h1>ğŸ“¦ ØªØ·Ø¨ÙŠÙ‚ ÙØ­Øµ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>

  <!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
  <video id="video" autoplay></video>
  <p id="scanResult">ğŸ‘‰ Ø¶Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</p>

  <!-- Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ -->
  <div>
    <input type="text" id="manualCode" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠÙ‹Ø§">
    <button onclick="searchProduct()">Ø¨Ø­Ø«</button>
  </div>

  <!-- ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© -->
  <div>
    <input type="date" id="expiryDate">
    <button onclick="checkExpiry()">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</button>
  </div>

  <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
  <div id="productInfo" class="card" style="display:none;"></div>
  <div id="expiryInfo" class="card" style="display:none;"></div>
  <div id="healthInfo" class="card" style="display:none;"></div>
  <div id="benefitsInfo" class="card" style="display:none;"></div>

  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const scanResult = document.getElementById("scanResult");

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©
    codeReader.listVideoInputDevices().then(devices => {
      if (devices.length > 0) {
        const backCam = devices.find(d => d.label.toLowerCase().includes('back')) || devices[0];
        codeReader.decodeFromVideoDevice(backCam.deviceId, 'video', (result, err) => {
          if (result) {
            scanResult.textContent = "âœ… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: " + result.getText();
            fetchProduct(result.getText());
          }
        });
      } else {
        scanResult.textContent = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªØ§Ø­Ø©";
      }
    });

    // Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠ
    function searchProduct() {
      const code = document.getElementById("manualCode").value.trim();
      if (code) {
        scanResult.textContent = "âœ… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: " + code;
        fetchProduct(code);
      }
    }

    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
    async function fetchProduct(code) {
      try {
        let res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
        let data = await res.json();
        if (data.status === 1) {
          displayProduct(data.product);
        } else {
          document.getElementById("productInfo").style.display = "block";
          document.getElementById("productInfo").innerHTML = "âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
        }
      } catch (e) {
        console.error(e);
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function displayProduct(product) {
      let productInfo = document.getElementById("productInfo");
      productInfo.style.display = "block";
      productInfo.innerHTML = `
        <h2>${product.product_name || "Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}</h2>
        <p><strong>Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª:</strong> ${product.ingredients_text || "ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©"}</p>
      `;

      // Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµØ­ÙŠ
      let nutriments = product.nutriments || {};
      let healthInfo = document.getElementById("healthInfo");
      healthInfo.style.display = "block";
      let sugar = nutriments.sugars_100g || 0;
      let salt = nutriments.salt_100g || 0;
      let fat = nutriments['saturated-fat_100g'] || 0;
      let energy = nutriments['energy-kcal_100g'] || 0;
      let fiber = nutriments.fiber_100g || 0;

      let healthText = `
        <h2>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµØ­ÙŠ</h2>
        <p>Ø³ÙƒØ±: ${sugar} Ø¬Ù… /100Ø¬Ù…</p>
        <p>Ù…Ù„Ø­: ${salt} Ø¬Ù… /100Ø¬Ù…</p>
        <p>Ø¯Ù‡ÙˆÙ† Ù…Ø´Ø¨Ø¹Ø©: ${fat} Ø¬Ù… /100Ø¬Ù…</p>
        <p>Ø³Ø¹Ø±Ø§Øª: ${energy} Ùƒ.Ø³ /100Ø¬Ù…</p>
        <p>Ø£Ù„ÙŠØ§Ù: ${fiber} Ø¬Ù… /100Ø¬Ù…</p>
      `;

      let risk = [];
      if (sugar > 15) risk.push("âš ï¸ Ù†Ø³Ø¨Ø© Ø§Ù„Ø³ÙƒØ± Ø¹Ø§Ù„ÙŠØ©");
      if (salt > 1.5) risk.push("âš ï¸ Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù„Ø­ Ù…Ø±ØªÙØ¹Ø©");
      if (fat > 5) risk.push("âš ï¸ ÙŠØ­ØªÙˆÙŠ Ø¯Ù‡ÙˆÙ† Ù…Ø´Ø¨Ø¹Ø© ÙƒØ«ÙŠØ±Ø©");
      if (energy > 400) risk.push("âš ï¸ Ø³Ø¹Ø±Ø§ØªÙ‡ Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© Ø¹Ø§Ù„ÙŠØ©");

      if (risk.length === 0) {
        healthText += "<p>âœ… Ø§Ù„Ù…Ù†ØªØ¬ ØµØ­ÙŠ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…</p>";
      } else {
        healthText += "<p>" + risk.join("<br>") + "</p>";
      }
      healthInfo.innerHTML = healthText;

      // Ø§Ù„ÙÙˆØ§Ø¦Ø¯ / Ø§Ù„Ø£Ø¶Ø±Ø§Ø±
      let benefitsInfo = document.getElementById("benefitsInfo");
      benefitsInfo.style.display = "block";
      let benefits = [];
      let harms = [];

      if (fiber > 2) benefits.push("ğŸ’š ØºÙ†ÙŠ Ø¨Ø§Ù„Ø£Ù„ÙŠØ§Ù ÙˆÙŠÙÙŠØ¯ Ø§Ù„Ù‡Ø¶Ù…");
      if (sugar > 15) harms.push("âŒ Ù‚Ø¯ ÙŠØ³Ø¨Ø¨ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆØ²Ù† Ø£Ùˆ ØªØ³ÙˆØ³ Ø§Ù„Ø£Ø³Ù†Ø§Ù†");
      if (fat > 5) harms.push("âŒ ÙŠØ±ÙØ¹ Ù†Ø³Ø¨Ø© Ø§Ù„ÙƒÙˆÙ„ÙŠØ³ØªØ±ÙˆÙ„");
      if (salt > 1.5) harms.push("âŒ Ù‚Ø¯ ÙŠØ³Ø¨Ø¨ Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ· Ø§Ù„Ø¯Ù…");

      benefitsInfo.innerHTML = `
        <h2>Ø§Ù„ÙÙˆØ§Ø¦Ø¯ ÙˆØ§Ù„Ø£Ø¶Ø±Ø§Ø±</h2>
        <p><strong>ÙÙˆØ§Ø¦Ø¯:</strong><br>${benefits.join("<br>") || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù…ÙŠØ²Ø§Øª Ø¨Ø§Ø±Ø²Ø©"}</p>
        <p><strong>Ø£Ø¶Ø±Ø§Ø±:</strong><br>${harms.join("<br>") || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ø·Ø± ÙƒØ¨ÙŠØ±Ø©"}</p>
      `;
    }

    // ÙØ­Øµ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
    function checkExpiry() {
      let expiryDate = document.getElementById("expiryDate").value;
      let expiryInfo = document.getElementById("expiryInfo");
      expiryInfo.style.display = "block";
      if (!expiryDate) {
        expiryInfo.innerHTML = "âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©";
        return;
      }
      let today = new Date();
      let exp = new Date(expiryDate);
      if (exp < today) {
        expiryInfo.innerHTML = "âŒ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©";
      } else {
        expiryInfo.innerHTML = "âœ… Ø§Ù„Ù…Ù†ØªØ¬ ØµØ§Ù„Ø­ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…";
      }
    }
  </script>
</body>
</html>
